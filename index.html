function doPost(e) {
  const lock = LockService.getScriptLock();
  lock.tryLock(10000);

  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheets()[0];
    const data = JSON.parse(e.postData.contents);
    
    // Append: Name, Type, Readable Time, Date Key
    // We force the Time cell to be text to prevent auto-formatting issues
    sheet.appendRow([data.name, data.punchType, "'" + data.timeReadable, data.dateKey]);
    
    return ContentService.createTextOutput(JSON.stringify({ result: 'success' }))
      .setMimeType(ContentService.MimeType.JSON);
  } catch (e) {
    return ContentService.createTextOutput(JSON.stringify({ result: 'error', error: e.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  } finally {
    lock.releaseLock();
  }
}

function doGet(e) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheets()[0];
  const rows = sheet.getDataRange().getValues();
  const headers = rows.shift(); // Remove headers
  
  // Map rows to object based on new column order
  const data = rows.map(row => ({
    name: row[0],
    punchType: row[1],
    timeReadable: row[2],
    dateKey: row[3]
  }));

  return ContentService.createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}
