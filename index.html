<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQAFK Break Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- CONFIGURATION ---
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwdwcICugjGibUDanBy2icpcTieVGYhg6eEWrLj2OQuCyZtGVGEf0yDTJ77JO_TZMq-/exec"; 
        const ADMIN_EMAIL = 'yuvraj.karki@bergtechnologies.co.in';
        const MAX_BREAK_MS = 3600000; // 1 hour

        // --- AUTHORIZED EMPLOYEES (Exact List) ---
        const AUTHORIZED_EMPLOYEES = [
            "yuvraj.karki@bergtechnologies.co.in",
            "aarti.singh@bergtechnologies.co.in",
            "abhilasha.abhilasha@bergtechnologies.co.in",
            "akriti.chandra@bergtechnologies.co.in",
            "aman.chandel@bergtechnologies.co.in",
            "anisha.singh@bergtechnologies.co.in",
            "amit.bandwal@bergtechnologies.co.in",
            "anchal.anchal@bergtechnologies.co.in",
            "anshuman.mamgain@bergtechnologies.co.in",
            "anuradha.rawat@bergtechnologies.co.in",
            "ayush.chauhan@bergtechnologies.co.in",
            "ayush.panwar@bergtechnologies.co.in",
            "ayush.singh@bergtechnologies.co.in",
            "badal.rana@bergtechnologies.co.in",
            "bhumi.vaish@bergtechnologies.co.in",
            "brijmohan.brijmohan@bergtechnologies.co.in",
            "gaurav.panwar@bergtechnologies.co.in",
            "himanshi.kandpal@bergtechnologies.co.in",
            "himanshu.mehta@bergtechnologies.co.in",
            "janvi.negi@bergtechnologies.co.in",
            "kanchan.negi@bergtechnologies.co.in",
            "kavita.negi@bergtechnologies.co.in",
            "khushi.uniyal@bergtechnologies.co.in",
            "manisha.tounk@bergtechnologies.co.in",
            "mohit.bhatt@bergtechnologies.co.in",
            "muskan.kala@bergtechnologies.co.in",
            "muskan.singh@bergtechnologies.co.in",
            "naman.walia@bergtechnologies.co.in",
            "neha.khatri@bergtechnologies.co.in",
            "nena.saini@bergtechnologies.co.in",
            "nikita.deori@bergtechnologies.co.in",
            "nitesha.sharma@bergtechnologies.co.in",
            "prashant.kumar1@bergtechnologies.co.in",
            "praveen.praveen@bergtechnologies.co.in",
            "priti.kumari@bergtechnologies.co.in",
            "priya.bhatt@bergtechnologies.co.in",
            "priyal.yadav@bergtechnologies.co.in",
            "pushpraj.pandey@bergtechnologies.co.in",
            "radhika.radhika@bergtechnologies.co.in",
            "ragini.maurya@bergtechnologies.co.in",
            "reeni.prajapati@bergtechnologies.co.in",
            "rishabh.sharma@bergtechnologies.co.in",
            "sagar.chauhan@bergtechnologies.co.in",
            "sakshi.ghildiyal@bergtechnologies.co.in",
            "shailesh.rawat@bergtechnologies.co.in",
            "shivain.chamoli@bergtechnologies.co.in",
            "siddharth.pal@bergtechnologies.co.in",
            "sunaina.tiwari@bergtechnologies.co.in",
            "sushma.kumari@bergtechnologies.co.in",
            "vandana.chaudhary@bergtechnologies.co.in",
            "varun.baliyan@bergtechnologies.co.in",
            "vasudev.verma@bergtechnologies.co.in",
            "vipul.panwar@bergtechnologies.co.in",
            "vivek.kumar@bergtechnologies.co.in"
        ];

        // --- HELPER FUNCTIONS ---
        const formatDuration = (ms) => {
            if (!ms || ms < 0) return '00:00:00';
            const h = Math.floor(ms / 3600000).toString().padStart(2, '0');
            const m = Math.floor((ms % 3600000) / 60000).toString().padStart(2, '0');
            const s = Math.floor((ms % 60000) / 1000).toString().padStart(2, '0');
            return `${h}:${m}:${s}`;
        };

        const getTodayDateKey = () => new Date().toISOString().slice(0, 10);

        // --- COMPONENTS ---

        const LoginScreen = ({ onLogin, error }) => {
            const [email, setEmail] = useState('');
            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-50 p-4">
                    <div className="w-full max-w-md bg-white p-8 rounded-xl shadow-lg space-y-6">
                        <div className="text-center">
                            <h1 className="text-3xl font-black text-blue-700">SQAFK Login</h1>
                            <p className="text-center text-gray-500 text-sm">Enter your authorized work email.</p>
                        </div>
                        {error && <div className="bg-red-100 text-red-700 p-3 rounded text-sm text-center">{error}</div>}
                        <input 
                            className="w-full p-3 border rounded focus:ring-2 focus:ring-blue-500 outline-none" 
                            placeholder="name@bergtechnologies.co.in" 
                            value={email} 
                            onChange={e=>setEmail(e.target.value)} 
                        />
                        <button 
                            onClick={() => onLogin(email.toLowerCase().trim())} 
                            className="w-full py-3 bg-blue-600 text-white rounded font-bold hover:bg-blue-700 transition"
                        >
                            Login
                        </button>
                    </div>
                </div>
            );
        };

        // --- MAIN APP COMPONENT ---
        const App = () => {
            const [user, setUser] = useState(localStorage.getItem('sqafk_user') || null);
            const [punches, setPunches] = useState([]);
            const [loading, setLoading] = useState(false);
            const [status, setStatus] = useState('');
            const [loginError, setLoginError] = useState('');
            
            // Stats
            const [dailyTotal, setDailyTotal] = useState(0);
            const [onBreak, setOnBreak] = useState(false);
            const [dailyCount, setDailyCount] = useState(0);

            // 1. Fetch Data Logic
            const fetchData = async () => {
                setLoading(true);
                setStatus('Syncing...');
                try {
                    const response = await fetch(GOOGLE_SCRIPT_URL);
                    const data = await response.json();
                    
                    // Sort data by timestamp (Oldest to Newest) to ensure correct calculation
                    data.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    
                    setPunches(data);
                    setStatus('Synced');
                } catch (error) {
                    console.error("Fetch error:", error);
                    setStatus('Sync Error - Check Internet');
                }
                setLoading(false);
            };

            // 2. Initial Load & Auto-Refresh
            useEffect(() => {
                if (user) {
                    fetchData(); // Load immediately
                    const interval = setInterval(fetchData, 30000); // Refresh every 30s
                    return () => clearInterval(interval);
                }
            }, [user]);

            // 3. Calculate Stats (Runs whenever punches or user changes)
            useEffect(() => {
                if (!user || punches.length === 0) return;

                const today = getTodayDateKey();
                
                // Filter for Current User & Today
                const myPunches = punches.filter(p => 
                    p.employeeId.toLowerCase() === user.toLowerCase() && 
                    p.dateKey === today
                );

                let total = 0;
                let lastIn = null;
                let isBrk = false;
                let count = 0;

                myPunches.forEach(p => {
                    const t = new Date(p.timestamp).getTime();
                    if (p.punchType === 'IN') { 
                        lastIn = t; 
                        isBrk = true; 
                    } else if (p.punchType === 'OUT' && lastIn) { 
                        total += (t - lastIn); 
                        lastIn = null; 
                        isBrk = false; 
                        count++;
                    }
                });

                // If currently on break, add live time estimation
                if (isBrk && lastIn) {
                    total += (Date.now() - lastIn);
                }
                
                setDailyTotal(total);
                setOnBreak(isBrk);
                setDailyCount(count);

            }, [punches, user]);

            // 4. Handle Punch
            const handlePunch = async (type) => {
                setLoading(true);
                setStatus('Saving...');
                
                const punchData = {
                    employeeId: user,
                    punchType: type,
                    timestamp: new Date().toISOString(),
                    dateKey: getTodayDateKey()
                };

                // Optimistic Update (Instant UI change)
                setPunches(prev => [...prev, punchData]);

                try {
                    await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors', // Standard for Google Apps Script POST
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(punchData)
                    });
                    setStatus('Saved!');
                    // Fetch real data after delay to sync with sheet
                    setTimeout(fetchData, 2000); 
                } catch (error) {
                    setStatus('Error saving');
                    alert("Network error: Check internet connection");
                }
                setLoading(false);
            };

            // 5. Login Handler
            const handleLogin = (email) => {
                if (!email) return;
                
                // Check against Authorized List
                if (AUTHORIZED_EMPLOYEES.includes(email) || email === ADMIN_EMAIL) {
                    localStorage.setItem('sqafk_user', email);
                    setUser(email);
                    setLoginError('');
                } else {
                    setLoginError("Access Denied: Email not authorized.");
                }
            };

            // 6. Logout Handler
            const handleLogout = () => {
                localStorage.removeItem('sqafk_user');
                setUser(null);
                setPunches([]);
                setDailyTotal(0);
                setDailyCount(0);
                setOnBreak(false);
            };

            // --- RENDER ---

            if (!user) return <LoginScreen onLogin={handleLogin} error={loginError} />;

            // Admin View
            if (user === ADMIN_EMAIL) {
                return (
                    <div className="min-h-screen p-4 bg-gray-100">
                        <div className="max-w-6xl mx-auto bg-white p-6 rounded-xl shadow">
                            <div className="flex justify-between mb-6">
                                <h1 className="text-2xl font-bold text-purple-700">Admin Dashboard (Sheets)</h1>
                                <button onClick={handleLogout} className="text-red-500 text-sm font-bold">Logout</button>
                            </div>
                            <button onClick={fetchData} className="mb-4 px-4 py-2 bg-blue-100 text-blue-700 rounded text-sm">
                                {loading ? 'Refreshing...' : 'Refresh Data'}
                            </button>
                            
                            <div className="overflow-x-auto max-h-96">
                                <table className="w-full text-sm text-left">
                                    <thead className="bg-gray-50 sticky top-0">
                                        <tr><th className="p-2">User</th><th className="p-2">Type</th><th className="p-2">Time</th></tr>
                                    </thead>
                                    <tbody>
                                        {[...punches].reverse().map((row, i) => (
                                            <tr key={i} className="border-b">
                                                <td className="p-2">{row.employeeId}</td>
                                                <td className={`p-2 font-bold ${row.punchType === 'IN' ? 'text-green-600' : 'text-red-600'}`}>{row.punchType}</td>
                                                <td className="p-2">{new Date(row.timestamp).toLocaleString()}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                );
            }

            // Employee View
            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-50 p-4">
                    <div className="w-full max-w-md bg-white rounded-2xl shadow-xl p-8 text-center space-y-6 relative">
                        <button onClick={handleLogout} className="absolute top-4 right-4 text-xs text-gray-400 hover:text-red-500">Logout</button>
                        
                        <h1 className="text-3xl font-black text-gray-800 tracking-tight mb-1">SQAFK</h1>
                        <p className="text-blue-600 font-medium text-sm uppercase tracking-widest">Break Tracker</p>
                        <p className="text-gray-500 text-xs">{user}</p>
                        
                        <div className={`p-6 rounded-2xl transition-colors ${onBreak ? 'bg-red-50 text-red-600' : 'bg-green-50 text-green-600'}`}>
                            <p className="text-xs font-bold uppercase">Total Time Today</p>
                            <p className="text-5xl font-black tabular-nums">{formatDuration(dailyTotal)}</p>
                            <p className="mt-2 font-medium">{onBreak ? 'Currently Away' : 'Working'}</p>
                        </div>
                        
                         <div className="flex justify-between text-center">
                             <div className="flex-1 bg-gray-50 p-3 rounded-lg mr-2">
                                 <p className="text-xl font-bold text-gray-800">{dailyCount}</p>
                                 <p className="text-[10px] font-bold text-gray-400 uppercase">Breaks</p>
                             </div>
                             <div className="flex-1 bg-gray-50 p-3 rounded-lg ml-2">
                                 <p className="text-xl font-bold text-gray-800">{getTodayDateKey()}</p>
                                 <p className="text-xs text-gray-500 uppercase font-bold">Today</p>
                             </div>
                        </div>

                        <div className="text-xs text-gray-400 h-4">{status}</div>

                        <div className="grid grid-cols-2 gap-4">
                            <button onClick={() => handlePunch('IN')} disabled={onBreak || loading} className="py-4 bg-green-500 text-white rounded-xl font-bold disabled:opacity-50 hover:bg-green-600 transition">START</button>
                            <button onClick={() => handlePunch('OUT')} disabled={!onBreak || loading} className="py-4 bg-red-500 text-white rounded-xl font-bold disabled:opacity-50 hover:bg-red-600 transition">END</button>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
