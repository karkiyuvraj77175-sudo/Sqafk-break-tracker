function doPost(e) {
  return handleRequest(e);
}

function doGet(e) {
  return handleRequest(e);
}

function handleRequest(e) {
  const lock = LockService.getScriptLock();
  lock.tryLock(10000);

  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const punchSheet = ss.getSheets()[0]; // First tab for Punches
    let empSheet = ss.getSheetByName("Employees"); // Second tab for Users
    
    // Safety: Create Employees sheet if missing
    if (!empSheet) {
      empSheet = ss.insertSheet("Employees");
      empSheet.appendRow(["Email", "Name"]);
      empSheet.appendRow(["yuvraj.karki@bergtechnologies.co.in", "Yuvraj Karki (Admin)"]);
    }

    // --- READ REQUESTS (GET) ---
    if (e.parameter && e.parameter.type === 'getUsers') {
      const rows = empSheet.getDataRange().getValues();
      rows.shift(); // Remove header
      // Filter out empty rows
      const users = rows.filter(r => r[0]).map(r => ({ email: r[0], name: r[1] }));
      return response(users);
    }
    
    if (!e.postData) {
      // Default GET: Return punches
      const rows = punchSheet.getDataRange().getValues();
      rows.shift();
      const data = rows.map(row => ({
        employeeId: row[0],
        punchType: row[1],
        timestamp: row[2],
        dateKey: row[3]
      }));
      return response(data);
    }

    // --- WRITE REQUESTS (POST) ---
    const data = JSON.parse(e.postData.contents);

    if (data.action === 'addUser') {
      empSheet.appendRow([data.email, data.name]);
      return response({ result: 'success', msg: 'User Added' });
    }

    if (data.action === 'removeUser') {
      const rows = empSheet.getDataRange().getValues();
      for (let i = 0; i < rows.length; i++) {
        if (rows[i][0] == data.email) {
          empSheet.deleteRow(i + 1);
          break;
        }
      }
      return response({ result: 'success', msg: 'User Removed' });
    }

    // Default POST: Record Punch
    punchSheet.appendRow([data.employeeId, data.punchType, data.timestamp, data.dateKey]);
    return response({ result: 'success' });

  } catch (err) {
    return response({ result: 'error', error: err.toString() });
  } finally {
    lock.releaseLock();
  }
}

function response(data) {
  return ContentService.createTextOutput(JSON.stringify(data)).setMimeType(ContentService.MimeType.JSON);
}
