<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQAFK Break Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase Modules -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, doc, getDoc, setDoc, onSnapshot, addDoc, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.firebaseModules = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut,
            getFirestore, collection, query, where, doc, getDoc, setDoc, onSnapshot, addDoc, getDocs, deleteDoc
        };
    </script>
</head>
<body class="bg-gray-100 text-gray-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;

        // --- CONFIGURATION ---
        const appId = 'sqafk-break-tracker';
        const ADMIN_ID = '17651586216758419693';
        const ADMIN_EMAIL = 'yuvraj.karki@bergtechnologies.co.in';
        const MAX_BREAK_MS = 3600000; // 1 hour

        // --- DATA DEFAULTS ---
        const DEFAULT_AUTHORIZED_EMPLOYEES = {
            [ADMIN_ID]: { email: ADMIN_EMAIL, name: 'Yuvraj Karki (Admin)' },
            [ADMIN_EMAIL]: { email: ADMIN_EMAIL, name: 'Yuvraj Karki (Admin)' },
            'aarti.singh@bergtechnologies.co.in': { name: 'Aarti Singh', email: 'aarti.singh@bergtechnologies.co.in' },
            'abhilasha.abhilasha@bergtechnologies.co.in': { name: 'Abhilasha Abhilasha', email: 'abhilasha.abhilasha@bergtechnologies.co.in' },
            'akriti.chandra@bergtechnologies.co.in': { name: 'Akriti Chandra', email: 'akriti.chandra@bergtechnologies.co.in' },
            'aman.chandel@bergtechnologies.co.in': { name: 'Aman Chandel', email: 'aman.chandel@bergtechnologies.co.in' },
            'anisha.singh@bergtechnologies.co.in': { name: 'Anisha Singh', email: 'anisha.singh@bergtechnologies.co.in' },
            'amit.bandwal@bergtechnologies.co.in': { name: 'Amit Bandwal', email: 'amit.bandwal@bergtechnologies.co.in' },
            'anchal.anchal@bergtechnologies.co.in': { name: 'Anchal Anchal', email: 'anchal.anchal@bergtechnologies.co.in' },
            'anshuman.mamgain@bergtechnologies.co.in': { name: 'Anshuman Mamgain', email: 'anshuman.mamgain@bergtechnologies.co.in' },
            'anuradha.rawat@bergtechnologies.co.in': { name: 'Anuradha Rawat', email: 'anuradha.rawat@bergtechnologies.co.in' },
            'ayush.chauhan@bergtechnologies.co.in': { name: 'Ayush Chauhan', email: 'ayush.chauhan@bergtechnologies.co.in' },
            'ayush.panwar@bergtechnologies.co.in': { name: 'Ayush Panwar', email: 'ayush.panwar@bergtechnologies.co.in' },
            'ayush.singh@bergtechnologies.co.in': { name: 'Ayush Singh', email: 'ayush.singh@bergtechnologies.co.in' },
            'badal.rana@bergtechnologies.co.in': { name: 'Badal Rana', email: 'badal.rana@bergtechnologies.co.in' },
            'bhumi.vaish@bergtechnologies.co.in': { name: 'Bhumi Vaish', email: 'bhumi.vaish@bergtechnologies.co.in' },
            'brijmohan.brijmohan@bergtechnologies.co.in': { name: 'Brijmohan Brijmohan', email: 'brijmohan.brijmohan@bergtechnologies.co.in' },
            'gaurav.panwar@bergtechnologies.co.in': { name: 'Gaurav Panwar', email: 'gaurav.panwar@bergtechnologies.co.in' },
            'himanshi.kandpal@bergtechnologies.co.in': { name: 'Himanshi Kandpal', email: 'himanshi.kandpal@bergtechnologies.co.in' },
            'himanshu.mehta@bergtechnologies.co.in': { name: 'Himanshu Mehta', email: 'himanshu.mehta@bergtechnologies.co.in' },
            'janvi.negi@bergtechnologies.co.in': { name: 'Janvi Negi', email: 'janvi.negi@bergtechnologies.co.in' },
            'kanchan.negi@bergtechnologies.co.in': { name: 'Kanchan Negi', email: 'kanchan.negi@bergtechnologies.co.in' },
            'kavita.negi@bergtechnologies.co.in': { name: 'Kavita Negi', email: 'kavita.negi@bergtechnologies.co.in' },
            'khushi.uniyal@bergtechnologies.co.in': { name: 'Khushi Uniyal', email: 'khushi.uniyal@bergtechnologies.co.in' },
            'manisha.tounk@bergtechnologies.co.in': { name: 'Manisha Tounk', email: 'manisha.tounk@bergtechnologies.co.in' },
            'mohit.bhatt@bergtechnologies.co.in': { name: 'Mohit Bhatt', email: 'mohit.bhatt@bergtechnologies.co.in' },
            'muskan.kala@bergtechnologies.co.in': { name: 'Muskan Kala', email: 'muskan.kala@bergtechnologies.co.in' },
            'muskan.singh@bergtechnologies.co.in': { name: 'Muskan Singh', email: 'muskan.singh@bergtechnologies.co.in' },
            'naman.walia@bergtechnologies.co.in': { name: 'Naman Walia', email: 'naman.walia@bergtechnologies.co.in' },
            'neha.khatri@bergtechnologies.co.in': { name: 'Neha Khatri', email: 'neha.khatri@bergtechnologies.co.in' },
            'nena.saini@bergtechnologies.co.in': { name: 'Nena Saini', email: 'nena.saini@bergtechnologies.co.in' },
            'nikita.deori@bergtechnologies.co.in': { name: 'Nikita Deori', email: 'nikita.deori@bergtechnologies.co.in' },
            'nitesha.sharma@bergtechnologies.co.in': { name: 'Nitesha Sharma', email: 'nitesha.sharma@bergtechnologies.co.in' },
            'prashant.kumar1@bergtechnologies.co.in': { name: 'Prashant Kumar', email: 'prashant.kumar1@bergtechnologies.co.in' },
            'praveen.praveen@bergtechnologies.co.in': { name: 'Praveen Praveen', email: 'praveen.praveen@bergtechnologies.co.in' },
            'priti.kumari@bergtechnologies.co.in': { name: 'Priti Kumari', email: 'priti.kumari@bergtechnologies.co.in' },
            'priya.bhatt@bergtechnologies.co.in': { name: 'Priya Bhatt', email: 'priya.bhatt@bergtechnologies.co.in' },
            'priyal.yadav@bergtechnologies.co.in': { name: 'Priyal Yadav', email: 'priyal.yadav@bergtechnologies.co.in' },
            'pushpraj.pandey@bergtechnologies.co.in': { name: 'Pushpraj Pandey', email: 'pushpraj.pandey@bergtechnologies.co.in' },
            'radhika.radhika@bergtechnologies.co.in': { name: 'Radhika Radhika', email: 'radhika.radhika@bergtechnologies.co.in' },
            'ragini.maurya@bergtechnologies.co.in': { name: 'Ragini Maurya', email: 'ragini.maurya@bergtechnologies.co.in' },
            'reeni.prajapati@bergtechnologies.co.in': { name: 'Reeni Prajapati', email: 'reeni.prajapati@bergtechnologies.co.in' },
            'rishabh.sharma@bergtechnologies.co.in': { name: 'Rishabh Sharma', email: 'rishabh.sharma@bergtechnologies.co.in' },
            'sagar.chauhan@bergtechnologies.co.in': { name: 'Sagar Chauhan', email: 'sagar.chauhan@bergtechnologies.co.in' },
            'sakshi.ghildiyal@bergtechnologies.co.in': { name: 'Sakshi Ghildiyal', email: 'sakshi.ghildiyal@bergtechnologies.co.in' },
            'shailesh.rawat@bergtechnologies.co.in': { name: 'Shailesh Rawat', email: 'shailesh.rawat@bergtechnologies.co.in' },
            'shivain.chamoli@bergtechnologies.co.in': { name: 'Shivain Chamoli', email: 'shivain.chamoli@bergtechnologies.co.in' },
            'siddharth.pal@bergtechnologies.co.in': { name: 'Siddharth Pal', email: 'siddharth.pal@bergtechnologies.co.in' },
            'sunaina.tiwari@bergtechnologies.co.in': { name: 'Sunaina Tiwari', email: 'sunaina.tiwari@bergtechnologies.co.in' },
            'sushma.kumari@bergtechnologies.co.in': { name: 'Sushma Kumari', email: 'sushma.kumari@bergtechnologies.co.in' },
            'vandana.chaudhary@bergtechnologies.co.in': { name: 'Vandana Chaudhary', email: 'vandana.chaudhary@bergtechnologies.co.in' },
            'varun.baliyan@bergtechnologies.co.in': { name: 'Varun Baliyan', email: 'varun.baliyan@bergtechnologies.co.in' },
            'vasudev.verma@bergtechnologies.co.in': { name: 'Vasudev Verma', email: 'vasudev.verma@bergtechnologies.co.in' },
            'vipul.panwar@bergtechnologies.co.in': { name: 'Vipul Panwar', email: 'vipul.panwar@bergtechnologies.co.in' },
            'vivek.kumar@bergtechnologies.co.in': { name: 'Vivek Kumar', email: 'vivek.kumar@bergtechnologies.co.in' }
        };

        // --- UTILS ---
        const formatDuration = (ms) => {
            if (!ms) return '00:00:00';
            const seconds = Math.floor(ms / 1000);
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            const pad = (num) => String(num).padStart(2, '0');
            return `${pad(h)}:${pad(m)}:${pad(s)}`;
        };

        const getTodayDateKey = () => new Date().toISOString().slice(0, 10);

        const convertToCSV = (data) => {
            if (!data || data.length === 0) return '';
            const headers = ["Name", "Date", "Breaks", "Total Time"];
            const rows = data.map(r => `"${r.employeeName}",${r.dateKey},${r.breakCount},${r.totalBreakFormatted}`).join("\n");
            return headers.join(",") + "\n" + rows;
        };

        const calculateTotalBreakTime = (currentPunches) => {
            let totalMs = 0, lastInTime = null, breakCount = 0, lastType = null;
            const sorted = [...currentPunches].sort((a, b) => a.timestamp.toMillis() - b.timestamp.toMillis());
            sorted.forEach(p => {
                const t = p.timestamp.toMillis();
                if (p.punchType === 'IN') lastInTime = t;
                else if (p.punchType === 'OUT' && lastInTime) { totalMs += (t - lastInTime); lastInTime = null; breakCount++; }
                lastType = p.punchType;
            });
            let onBreak = !!lastInTime;
            if (onBreak) totalMs += (Date.now() - lastInTime);
            return { totalMs, currentlyOnBreak: onBreak, lastPunchType: onBreak ? 'IN' : lastType, breakCount };
        };

        // --- COMPONENTS ---

        const SetupScreen = ({ onSave }) => {
            const [val, setVal] = useState('');
            const [err, setErr] = useState('');
            const save = () => {
                try {
                    let input = val.trim();
                    // 1. Remove comments and leading 'const firebaseConfig ='
                    input = input.replace(/\/\*[\s\S]*?\*\/|([^\\:])\/\/.*/g, '$1');
                    input = input.replace(/const\s+firebaseConfig\s*=\s*/, '');
                    input = input.slice(input.indexOf('{'), input.lastIndexOf('}') + 1);
                    
                    // 2. Add quotes to unquoted keys (e.g., apiKey -> "apiKey")
                    let json = input.replace(/([a-zA-Z0-9_]+):/g, '"$1":');
                    
                    // 3. Remove trailing commas (critical for JSON parsing)
                    json = json.replace(/,\s*([\]}])/g, '$1');
                    
                    const config = JSON.parse(json);
                    if(!config.apiKey) throw new Error("Missing apiKey");
                    localStorage.setItem('sqafk_firebase_config', JSON.stringify(config));
                    onSave(config);
                } catch(e) { 
                    setErr("Invalid Config. Error: " + e.message + ". Ensure you copied the FULL object, including { and }."); 
                }
            };
            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-50 p-4">
                    <div className="w-full max-w-md bg-white p-8 rounded-xl shadow-lg space-y-4">
                        <h2 className="text-xl font-bold text-center text-blue-700">Connect Database</h2>
                        <p className="text-sm text-gray-600">Paste your Firebase Config object below:</p>
                        <textarea className="w-full h-32 p-2 border rounded text-xs font-mono" value={val} onChange={e=>setVal(e.target.value)} placeholder='{ "apiKey": "...", ... }'></textarea>
                        {err && <p className="text-red-500 text-xs">{err}</p>}
                        <button onClick={save} className="w-full py-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-700">Connect</button>
                    </div>
                </div>
            );
        };

        const EmployeeManagement = ({ db, authList, setStatusMessage }) => {
            const [newEmail, setNewEmail] = useState('');
            const [newName, setNewName] = useState('');
            const [isSaving, setIsSaving] = useState(false);

            const handleUpdate = async (newList, msg) => {
                setIsSaving(true);
                try {
                    const { doc, setDoc } = window.firebaseModules;
                    await setDoc(doc(db, `artifacts/${appId}/public/data/config`, 'auth_list'), { list: newList });
                    setStatusMessage(msg);
                    setNewEmail(''); setNewName('');
                } catch(e) { setStatusMessage("Error: " + e.message); }
                setIsSaving(false);
            };

            const handleAdd = () => {
                if(!newEmail || !newName) return;
                const list = { ...authList, [newEmail.toLowerCase()]: { name: newName, email: newEmail.toLowerCase() } };
                handleUpdate(list, `Added ${newName}`);
            };

            const handleRemove = (email) => {
                const list = { ...authList };
                delete list[email];
                handleUpdate(list, `Removed ${email}`);
            };
            
            const handleInit = () => handleUpdate(DEFAULT_AUTHORIZED_EMPLOYEES, "Initialized Defaults");

            const sortedList = Object.entries(authList).filter(([k]) => k !== ADMIN_ID && k !== ADMIN_EMAIL).sort((a,b) => a[1].name.localeCompare(b[1].name));

            return (
                <div className="space-y-4">
                    <div className="flex justify-between items-center">
                        <h3 className="font-bold text-lg">Manage Access</h3>
                        {Object.keys(authList).length === 0 && <button onClick={handleInit} disabled={isSaving} className="text-xs bg-red-100 text-red-600 px-2 py-1 rounded border border-red-200">Initialize Defaults</button>}
                    </div>
                    <div className="flex gap-2 flex-col sm:flex-row">
                        <input className="border p-2 rounded flex-1" placeholder="Email" value={newEmail} onChange={e => setNewEmail(e.target.value)} disabled={isSaving} />
                        <input className="border p-2 rounded flex-1" placeholder="Name" value={newName} onChange={e => setNewName(e.target.value)} disabled={isSaving} />
                        <button onClick={handleAdd} disabled={isSaving} className="bg-purple-600 text-white px-4 py-2 rounded disabled:bg-gray-400">Add</button>
                    </div>
                    <div className="max-h-60 overflow-y-auto border rounded bg-white">
                        {sortedList.map(([key, val]) => (
                            <div key={key} className="flex justify-between items-center p-2 border-b hover:bg-gray-50">
                                <span className="text-sm font-medium">{val.name} <br/><span className="text-gray-400 text-xs font-normal">{val.email}</span></span>
                                {val.email !== ADMIN_EMAIL && <button onClick={() => handleRemove(val.email)} disabled={isSaving} className="text-red-500 text-xs border border-red-200 px-2 py-1 rounded hover:bg-red-50">Remove</button>}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const AdminReport = ({ db, allPunches, authList, setStatusMessage }) => {
             const [filter, setFilter] = useState('');
             const [messageDraft, setMessageDraft] = useState('');
             const [isGenerating, setIsGenerating] = useState(false);
             
             const reportData = useMemo(() => {
                const map = {};
                const nameMap = Object.values(authList).reduce((acc, e) => { if(e.email) acc[e.email.toLowerCase()] = e.name; return acc; }, {});
                nameMap[ADMIN_ID] = 'Yuvraj Karki (Admin)'; nameMap[ADMIN_EMAIL] = 'Yuvraj Karki (Admin)';

                allPunches.forEach(p => {
                    let id = p.employeeId.toLowerCase();
                    if (!nameMap[id] && p.employeeId !== ADMIN_ID) return;
                    const key = `${id}_${p.dateKey}`;
                    if (!map[key]) map[key] = { id, employeeName: nameMap[id] || id, dateKey: p.dateKey, punches: [] };
                    map[key].punches.push(p);
                });
                
                return Object.values(map).map(entry => {
                     const { totalMs, currentlyOnBreak, breakCount } = calculateTotalBreakTime(entry.punches);
                     return { ...entry, totalBreakMs: totalMs, totalBreakFormatted: formatDuration(totalMs), currentlyOnBreak, breakCount };
                }).sort((a,b) => b.dateKey.localeCompare(a.dateKey));
             }, [allPunches, authList]);

             const handleExport = () => {
                 const blob = new Blob([convertToCSV(reportData)], {type: 'text/csv'});
                 const url = URL.createObjectURL(blob);
                 const a = document.createElement('a');
                 a.href = url; a.download = `sqafk_report.csv`; a.click();
             };
             
             const handleCleanup = async () => {
                if (!window.confirm("Delete logs older than 15 days?")) return;
                setStatusMessage("Cleaning...");
                try {
                    const { collection, getDocs, deleteDoc, query } = window.firebaseModules;
                    const fifteenDaysAgo = new Date(); fifteenDaysAgo.setDate(fifteenDaysAgo.getDate() - 15);
                    const snap = await getDocs(query(collection(db, `artifacts/${appId}/public/data/punches`)));
                    let count = 0;
                    snap.docs.forEach(d => { if(d.data().timestamp?.toDate() < fifteenDaysAgo) { deleteDoc(d.ref); count++; } });
                    setStatusMessage(`Deleted ${count} records.`);
                } catch(e) { setStatusMessage("Cleanup Error"); }
             };

             const handleGenerateMessage = async (item) => {
                 setIsGenerating(true); setMessageDraft('');
                 const statusText = item.totalBreakMs > MAX_BREAK_MS ? 'EXCEEDED LIMIT' : 'WITHIN LIMIT';
                 // Mock AI call for stability
                 setTimeout(() => {
                     setMessageDraft(`Subject: Break Log Review - ${item.dateKey}\n\nDear ${item.employeeName},\n\nThis is regarding your break log for ${item.dateKey}. You took ${item.breakCount} breaks totaling ${item.totalBreakFormatted}. Compliance status: ${statusText}.\n\nBest,\nHR`);
                     setIsGenerating(false);
                     setStatusMessage("Draft generated.");
                 }, 1000);
            };

             const filteredData = reportData.filter(r => r.employeeName.toLowerCase().includes(filter.toLowerCase()) || r.dateKey.includes(filter));

             return (
                 <div className="space-y-4">
                    {messageDraft && (
                        <div className="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-xl p-6 space-y-4 w-full max-w-lg">
                                <h3 className="text-xl font-bold">Draft Message</h3>
                                <div className="p-3 bg-gray-100 rounded whitespace-pre-wrap">{messageDraft}</div>
                                <button onClick={() => setMessageDraft('')} className="px-4 py-2 bg-gray-500 text-white rounded">Close</button>
                            </div>
                        </div>
                    )}
                    <div className="flex justify-between items-center flex-wrap gap-2">
                        <h3 className="font-bold text-lg">Daily Report</h3>
                        <div className="flex gap-2">
                             <input className="border p-1 px-2 rounded text-sm" placeholder="Filter..." value={filter} onChange={e => setFilter(e.target.value)} />
                             <button onClick={handleExport} className="bg-blue-600 text-white px-3 py-1 rounded text-sm">Export CSV</button>
                             <button onClick={handleCleanup} className="bg-red-600 text-white px-3 py-1 rounded text-sm">Cleanup Old</button>
                        </div>
                    </div>
                    <div className="overflow-x-auto border rounded-lg shadow-sm">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-gray-100 font-bold text-gray-700">
                                <tr><th className="p-3">Name</th><th className="p-3">Date</th><th className="p-3">Total Time</th><th className="p-3 text-center">Breaks</th><th className="p-3 text-center">Status</th><th className="p-3">Action</th></tr>
                            </thead>
                            <tbody className="bg-white divide-y">
                                {filteredData.map(row => (
                                    <tr key={row.id + row.dateKey} className="hover:bg-gray-50">
                                        <td className="p-3 font-medium">{row.employeeName}</td>
                                        <td className="p-3 text-gray-500">{row.dateKey}</td>
                                        <td className={`p-3 font-mono font-bold ${row.totalBreakMs > MAX_BREAK_MS ? 'text-red-600' : 'text-gray-700'}`}>{row.totalBreakFormatted} {row.totalBreakMs > MAX_BREAK_MS && '‚ö†Ô∏è'}</td>
                                        <td className="p-3 text-center">{row.breakCount}</td>
                                        <td className="p-3 text-center">{row.currentlyOnBreak ? 'ON BREAK' : 'Complete'}</td>
                                        <td className="p-3"><button onClick={() => handleGenerateMessage(row)} className="px-2 py-1 bg-indigo-500 text-white text-xs rounded hover:bg-indigo-600">{isGenerating ? '...' : 'Draft'}</button></td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                 </div>
             );
        };

        const AdminDashboard = ({ db, userId, allPunches, statusMessage, setStatusMessage, authList, isAuthReady, calculateTotalBreakTime }) => {
            const [activeTab, setActiveTab] = useState('report');
            return (
                <div className="p-4 md:p-8 bg-white rounded-xl shadow-2xl w-full max-w-5xl mx-auto space-y-6">
                    <h1 className="text-3xl font-extrabold text-purple-700 tracking-tight border-b pb-3">Admin Panel</h1>
                    <p className="text-sm text-gray-500">{statusMessage}</p>
                    <div className="flex border-b">
                        <button onClick={() => setActiveTab('report')} className={`py-2 px-4 ${activeTab==='report'?'border-b-4 border-purple-600 text-purple-600':'text-gray-500'}`}>Report</button>
                        <button onClick={() => setActiveTab('manage')} className={`py-2 px-4 ${activeTab==='manage'?'border-b-4 border-purple-600 text-purple-600':'text-gray-500'}`}>Manage Access</button>
                    </div>
                    <div className="pt-4">
                        {activeTab === 'report' ? <AdminReport db={db} allPunches={allPunches} calculateTotalBreakTime={calculateTotalBreakTime} authList={authList} isAuthReady={isAuthReady} setStatusMessage={setStatusMessage} /> : <EmployeeManagement db={db} authList={authList} setStatusMessage={setStatusMessage} />}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [firebaseConfig, setFirebaseConfig] = useState(null);
            const [status, setStatus] = useState('Initializing...');
            const [authList, setAuthList] = useState({});
            const [punches, setPunches] = useState([]);
            const [allPunches, setAllPunches] = useState([]);
            const [dailyTotal, setDailyTotal] = useState(0);
            const [dailyCount, setDailyCount] = useState(0);
            const [onBreak, setOnBreak] = useState(false);
            const [isAdminView, setIsAdminView] = useState(false);
            const [isAuthorizedEmployee, setIsAuthorizedEmployee] = useState(false);
            const [isAdmin, setIsAdmin] = useState(false);
            const [isAuthReady, setIsAuthReady] = useState(false);

            useEffect(() => {
                const saved = localStorage.getItem('sqafk_firebase_config');
                if (saved) {
                    try { setFirebaseConfig(JSON.parse(saved)); } catch (e) { localStorage.removeItem('sqafk_firebase_config'); }
                }
            }, []);

            useEffect(() => {
                if(!firebaseConfig) return;
                const { initializeApp, getAuth, getFirestore, onAuthStateChanged, signInAnonymously, signInWithCustomToken } = window.firebaseModules;
                
                try { initializeApp(firebaseConfig); } catch(e) {}
                const auth = getAuth();
                const db = getFirestore();

                const initAuth = async () => {
                     setStatus('Authenticating...');
                     try {
                        const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        if(token) await signInWithCustomToken(auth, token);
                        else await signInAnonymously(auth);
                     } catch(error) { setStatus('Auth Failed: ' + error.code); }
                };
                initAuth();

                onAuthStateChanged(auth, (u) => {
                    if(u) {
                        setUser(u);
                        setStatus('Loading Data...');
                        
                        const { doc, onSnapshot, collection, query, where, setDoc } = window.firebaseModules;
                        
                        // Auth List Listener
                        onSnapshot(doc(db, `artifacts/${appId}/public/data/config`, 'auth_list'), (snap) => {
                            if(snap.exists()) {
                                setAuthList(snap.data().list || {});
                                const uid = u.uid;
                                const email = u.email ? u.email.toLowerCase() : '';
                                const isAdmin = (uid === ADMIN_ID || email === ADMIN_EMAIL);
                                const isAuth = snap.data().list[uid] || snap.data().list[email] || isAdmin;
                                setIsAuthorizedEmployee(!!isAuth);
                                setIsAdmin(isAdmin);
                            }
                            else if(u.uid === ADMIN_ID || (u.email && u.email === ADMIN_EMAIL)) {
                                setDoc(doc(db, `artifacts/${appId}/public/data/config`, 'auth_list'), { list: DEFAULT_AUTHORIZED_EMPLOYEES });
                                setIsAuthorizedEmployee(true);
                                setIsAdmin(true);
                            } else {
                                setAuthList({});
                                setIsAuthorizedEmployee(false);
                                setIsAdmin(false);
                            }
                        }, (err) => console.warn("Auth sync error:", err.code));

                        // User Punches
                        const q = query(collection(db, `artifacts/${appId}/public/data/punches`), where("dateKey", "==", new Date().toISOString().slice(0,10)));
                        
                        onSnapshot(q, (snap) => {
                            const p = [];
                            snap.forEach(d => {
                                const data = d.data();
                                if(data.employeeId === u.uid || (u.email && data.employeeId === u.email.toLowerCase())) {
                                    p.push(data);
                                }
                            });
                            const { totalMs, breakCount, currentlyOnBreak } = calculateTotalBreakTime(p);
                            setDailyTotal(totalMs); setDailyCount(breakCount); setOnBreak(currentlyOnBreak);
                        });

                        // Admin Punches
                        if (u.uid === ADMIN_ID || u.email === ADMIN_EMAIL) {
                             onSnapshot(query(collection(db, `artifacts/${appId}/public/data/punches`)), (snap) => {
                                 const all = []; snap.forEach(d => all.push(d.data())); setAllPunches(all);
                             });
                        }
                    } else {
                        setUser(null); setStatus('Signed Out');
                        setIsAuthorizedEmployee(false);
                        setIsAdmin(false);
                    }
                    setIsAuthReady(true);
                });
            }, [firebaseConfig]);

            const handlePunch = async (type) => {
                const { addDoc, collection, getFirestore } = window.firebaseModules;
                const db = getFirestore();
                const id = user.email ? user.email.toLowerCase() : user.uid;
                await addDoc(collection(db, `artifacts/${appId}/public/data/punches`), {
                    employeeId: id, punchType: type, timestamp: new Date(), dateKey: new Date().toISOString().slice(0,10)
                });
            };

            const handleLogout = () => {
                const { signOut, getAuth } = window.firebaseModules;
                signOut(getAuth());
            };

            if(!firebaseConfig) return <SetupScreen onSave={setFirebaseConfig} />;
            if(!user || !isAuthReady) return <div className="h-screen flex items-center justify-center text-gray-500">{status}</div>;

            const isAdminCheck = (user.uid === ADMIN_ID || user.email === ADMIN_EMAIL);
            
            // Only re-calculate name if we have authList
            const isAuth = authList[user.uid] || (user.email && authList[user.email.toLowerCase()]) || isAdminCheck;
            const name = authList[user.email?.toLowerCase()]?.name || authList[user.uid]?.name || "User";

            if(!isAuth && !isAdminCheck && Object.keys(authList).length > 0) return (
                 <div className="h-screen flex items-center justify-center p-4 bg-gray-50">
                    <div className="bg-white p-8 rounded shadow text-center">
                        <h2 className="text-xl font-bold text-red-600 mb-2">Access Denied</h2>
                        <p>Your ID is not authorized.</p>
                        <button onClick={handleLogout} className="mt-4 text-blue-600 underline">Logout</button>
                    </div>
                </div>
            );

            if(isAdminView && isAdminCheck) {
                return (
                    <div className="min-h-screen p-4 flex justify-center bg-gray-100">
                        <div className="w-full max-w-6xl bg-white rounded-xl shadow p-6">
                            <div className="flex justify-between items-center mb-6 border-b pb-4">
                                <h1 className="text-2xl font-bold text-purple-700">Admin Panel</h1>
                                <button onClick={() => setIsAdminView(false)} className="bg-gray-100 px-6 py-2 rounded-full hover:bg-gray-200 font-medium">Back to Timer</button>
                            </div>
                            <EmployeeManagement db={window.firebaseModules.getFirestore()} authList={authList} setStatusMessage={setStatus} />
                            <div className="my-8 border-t border-gray-100"></div>
                            <AdminReport db={window.firebaseModules.getFirestore()} allPunches={allPunches} authList={authList} setStatusMessage={setStatus} />
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen flex items-center justify-center p-4 bg-gray-50">
                    <div className="w-full max-w-md bg-white rounded-2xl shadow-xl p-8 space-y-8 relative">
                        <div className="absolute top-4 right-4">
                             <button onClick={handleLogout} className="text-gray-400 hover:text-red-500 text-xs font-medium transition">Logout</button>
                        </div>
                        <div className="text-center pb-2">
                            <h1 className="text-3xl font-black text-gray-800 tracking-tight mb-1">SQAFK</h1>
                            <p className="text-blue-600 font-medium text-sm uppercase tracking-widest">Break Tracker</p>
                            <div className="mt-6 inline-block px-4 py-1 bg-gray-100 rounded-full text-sm font-medium text-gray-600">üëã Hi, {name.split(' ')[0]}</div>
                        </div>
                        <div className={`text-center p-6 rounded-2xl ${onBreak ? 'bg-red-50 ring-2 ring-red-100' : 'bg-green-50 ring-2 ring-green-100'}`}>
                            <p className="text-gray-500 font-medium text-xs uppercase tracking-wide mb-1">Total Break Time</p>
                            <p className={`text-5xl font-black tabular-nums tracking-tight ${onBreak ? 'text-red-500' : 'text-green-600'}`}>{formatDuration(dailyTotal)}</p>
                            <p className="text-sm font-medium text-gray-600 mt-4">{onBreak ? 'Currently Away' : 'Active / Working'}</p>
                        </div>
                        <div className="grid grid-cols-2 gap-4 pt-2">
                             <div className="text-center p-3 bg-gray-50 rounded-xl"><p className="text-2xl font-bold text-gray-800">{dailyCount}</p><p className="text-xs text-gray-500 uppercase font-bold">Breaks</p></div>
                             <div className="text-center p-3 bg-gray-50 rounded-xl"><p className="text-2xl font-bold text-gray-800">{new Date().toLocaleDateString(undefined, {weekday: 'short'})}</p><p className="text-xs text-gray-500 uppercase font-bold">Today</p></div>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            <button onClick={() => handlePunch('IN')} disabled={onBreak} className={`py-4 rounded-xl font-bold text-white shadow-lg transform transition hover:-translate-y-0.5 ${onBreak ? 'bg-gray-200 text-gray-400 cursor-not-allowed shadow-none' : 'bg-green-500'}`}>START BREAK</button>
                            <button onClick={() => handlePunch('OUT')} disabled={!onBreak} className={`py-4 rounded-xl font-bold text-white shadow-lg transform transition hover:-translate-y-0.5 ${!onBreak ? 'bg-gray-200 text-gray-400 cursor-not-allowed shadow-none' : 'bg-red-500'}`}>END BREAK</button>
                        </div>
                        {isAdmin && <div className="mt-8 text-center"><button onClick={() => setIsAdminView(true)} className="text-xs font-semibold text-purple-600 hover:text-purple-800 border-b border-purple-200 hover:border-purple-600">Access Admin Dashboard</button></div>}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
